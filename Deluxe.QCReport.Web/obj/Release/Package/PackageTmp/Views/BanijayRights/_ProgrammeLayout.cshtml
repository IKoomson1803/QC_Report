@model Deluxe.QCReport.Web.Models.HomeVM

@{
    var itemNo = 0;
    var itemCount = Model.BanijahRightsProgrammeLayout.TapeLayouts.Count;

    var nextItemNo = 1;
    var lastItem = Model.BanijahRightsProgrammeLayout.TapeLayouts.OrderByDescending(m => m.ItemNum).FirstOrDefault();
    if (lastItem != null) { nextItemNo = lastItem.ItemNum + 1; }
   
}

<div class="bs-callout bs-callout-warning">
    @using (Html.BeginForm("SaveProgrammeLayout", "BanijayRights", FormMethod.Post, new { @class = "form-horizontal form-group-sm", @style = "margin-top: 20px;", @id = "form_jobdetails" }))
    {


        <div class="row" style="margin-top: -25px;">
            <div class="col-xs-8" style="font-size:14px;font-weight:bold">
                @string.Format("{0} - {1}: Banijay Rights - Layout", Model.BanijahRightsProgrammeLayout.QCNum, Model.BanijahRightsProgrammeLayout.SubQCNum)
            </div>
        </div>

        @Html.HiddenFor(m => m.BanijahRightsProgrammeLayout.Id);
        @Html.HiddenFor(m => m.BanijahRightsProgrammeLayout.QCNum);
        @Html.HiddenFor(m => m.BanijahRightsProgrammeLayout.SubQCNum);
        @Html.HiddenFor(m => m.BanijahRightsTapeLayout.QCNum)
        @Html.HiddenFor(m => m.BanijahRightsTapeLayout.SubQCNum)
        @Html.HiddenFor(m => m.BanijahRightsTapeLayout.Id)

        <div class="row" style="margin-top: -25px;">
            <div class="col-xs-8">
                &nbsp;
            </div>
        </div>

        <div class="row">
            <div class="col-xs-1 form-group" style="margin-left:5px;">
                <label class="control-label">Programme:</label>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-1 form-group" style="margin-left: 5px; width: 160px">
                <label class="control-label">Programme In:</label>
            </div>
            <div class="col-xs-1 form-group" style="margin-left:5px">
                @Html.TextBoxFor(m => m.BanijahRightsProgrammeLayout.ProgrammeIn,
              new { @class = "form-control timecode programme", placeholder = "hh:mm:ss:ff", maxlength = "11", @style = "width:90px" })
            </div>


            <div class="col-xs-1 form-group text-right" style="margin-left: 5px; width: 200px">
                <label class="control-label">Programme Out:</label>
            </div>
            <div class="col-xs-1 form-group text-right" style="margin-left: 5px; width: 100px">
                @Html.TextBoxFor(m => m.BanijahRightsProgrammeLayout.ProgrammeOut,
               new { @class = "form-control timecode programme", placeholder = "hh:mm:ss:ff", maxlength = "11", @style = "width:90px" })
            </div>

            <div class="col-xs-1 form-group text-right" style="margin-left: 5px; width: 220px">
                <label class="control-label">Total Length Including Breaks:</label>
            </div>
            <div class="col-xs-1 form-group text-right" style="margin-left: 5px; width: 100px">
                @Html.TextBoxFor(m => m.BanijahRightsProgrammeLayout.TotalLengthIncludingBreaks,
               new { @class = "form-control timecode programme", placeholder = "hh:mm:ss:ff", maxlength = "11", @style = "width:90px" })
            </div>

        </div>



        <div class="row">
            <div class="col-xs-1 form-group" style="margin-left: 5px; width: 160px">
                <label class="control-label">Programme Duration:</label>
            </div>
            <div class="col-xs-1 form-group text-right" style="margin-left:5px;">
                @Html.TextBoxFor(m => m.BanijahRightsProgrammeLayout.ProgrammeDuration,
              new { @class = "form-control programme", maxlength = "11", @style = "width:90px" })
            </div>


            <div class="col-xs-1 form-group  text-right"  style="margin-left: 5px; width: 200px">
                <label class="control-label"> Number of parts:</label>
            </div>
            <div class="col-xs-2 form-group text-right" style="margin-left: 5px; width: 100px"t>
                @Html.TextBoxFor(m => m.BanijahRightsProgrammeLayout.NumberOfParts,
               new { @class = "form-control programme", @style = "width:60px", @type = "number" })
            </div>

        </div>

        <div class="row">
            <div class="col-xs-1 form-group" style="margin-left: 5px; width: 160px">
                <label class="control-label"> Slate / Clock Accurate:</label>
            </div>
            <div class="col-xs-1 form-group " style="margin-left:5px;">
                @Html.DropDownListFor(m => m.BanijahRightsProgrammeLayout.SlateAccurate,
                          new SelectList(Model.YesNoNAList, "value", "value", 
                          Model.BanijahRightsProgrammeLayout.SlateAccurate), "",
                          new { @class = "form-control programme", @style = "width:50px" })
            </div>


            <div class="col-sm-1 form-group  text-right" style="margin-left: 5px; width: 200px">
                <label class="control-label">Next week / trailer present:</label>
            </div>
            <div class="col-sm-1 form-group text-right" style="margin-left: 5px; width: 200px">
                @Html.DropDownListFor(m => m.BanijahRightsProgrammeLayout.NextWeekOrTrailerPresent,
                          new SelectList(Model.NextWeekOrTrailerPresentList, "value", "value", Model.BanijahRightsProgrammeLayout.NextWeekOrTrailerPresent), "",
                          new { @class = "form-control programme", @style = "width:100px" })
            </div>

        </div>

        <hr />

        <br />

        if (Model.SecurityLevel >= 1)
        {
            <div class="row">
                <div class="col-xs-4">
                    &nbsp;
                </div>
                <div class="col-xs-4">
                    <div>
                        <button type="button" class="btn btn-xs btn-primary CRUDButton" id="btnSave">Save</button>
                        <button type="button" class="btn btn-xs btn-danger CRUDButton" id="#btnReset" onclick="Reset()">Reset</button>
                        <button type="button" class="btn btn-xs btn-warning CRUDButton" id="btnDeletePrompt" disabled>Delete</button>
                    </div>

                </div>
            </div>

            <br />
        }

<div class="row">

    <div class="col-xs-1 form-group" style="margin-left:5px;">

        <label class="control-label">Item No:</label>
        @Html.TextBoxFor(m => m.BanijahRightsTapeLayout.ItemNum, 
       new { @class = "form-control", @type = "number", @width = "40px" })
    </div>

    <div class="col-xs-2 form-group" style="margin-left:5px;">
        <label class="control-label">Layout:</label>
        @Html.TextBoxFor(m => m.BanijahRightsTapeLayout.Type,
      new { @class = "form-control", @style = "width:150px" })
    </div>

    <div class="col-xs-2 form-group " style="margin-left:5px;">
        <label class="control-label">Timecode In:</label>
        @Html.TextBoxFor(m => m.BanijahRightsTapeLayout.TimecodeIn,
       new { @class = "form-control timecode", placeholder = "hh:mm:ss:ff", maxlength = "11", @style = "width:90px" })

    </div>

    <div class="col-xs-2 form-group" style="margin-left:12px;">
        <label class="control-label">Timecode Out:</label>
        @Html.TextBoxFor(m => m.BanijahRightsTapeLayout.TimecodeOut,
       new { @class = "form-control timecode", placeholder = "hh:mm:ss:ff", maxlength = "11", @style = "width:90px" })
    </div>

    <div class="col-xs-2 form-group" style="margin-left:12px;">
        <label class="control-label">Part Duration ex holds:</label>
        @Html.TextBoxFor(m => m.BanijahRightsTapeLayout.PartDurationExcludingHolds,
       new { @class = "form-control", maxlength = "100", @style = "width:200px" })
    </div>

    <div class="col-xs-2 form-group" style="margin-left:12px;">
        <label class="control-label">Count As Show:</label>
        @Html.DropDownListFor(m => m.BanijahRightsTapeLayout.CountAsShow,
                  new SelectList(Model.CountAsShowList, "value", "value", Model.BanijahRightsTapeLayout.CountAsShow), "",
                  new { @class = "form-control", @style = "width:90px" })
    </div>
</div>

        <div id="divTapeLayoutGrid" class="row">
            @{Html.RenderPartial("_TapeLayoutGrid", Model);}
        </div>

    }



</div>

<!-- Modal -->
<div class="modal fade" id="deletePromptModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-body" style="font-size:14px;font-weight:bold;">

            </div>
            <div class="modal-footer">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-sm btn-danger" id="btnDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>

    function setActiveButton() {
        $(".subMenuOnClick").removeClass("subMenuOnClick")
        $('#lnkBNJRProgrammeLayout').addClass("subMenuOnClick");
    }

    $(function () {
        $(function () {
                setActiveButton();

                var securityLevel = @Model.SecurityLevel

                $(".timecode").mask("99:99:99:99");

                  $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.ItemNum)').val(@nextItemNo);

                $(".programme").blur(function () {

                    if (securityLevel >= 1)
                    {
                        saveProgramme();
                    }

                });


            $('#btnSave').on("click", function () {

                if ($('#@Html.IdFor(m => m.BanijahRightsTapeLayout.ItemNum)').val() == '') {
                    alert("Please add an item number and continue... ")
                    return;
                }

              if ($('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Type)').val() == '') {
                  Msg.success("Please add a tape layout type and continue... ", 2 * 1000);
                  return;
              }

              if ($('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeIn)').val() == '_:_:_'
               && $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeIn)').val() == '') {
                  Msg.success("Please add a tape layout timecode in and continue... ", 2 * 1000);
                  return;
              }

              if ($('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeOut)').val() == '_:_:_'
              && $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeOut)').val() == '') {
                  Msg.success("Please add a tape layout timecode out and continue... ", 2 * 1000);
                  return;
              }

            var qcno = '@Model.BanijahRightsProgrammeLayout.QCNum';
            var revno = '@Model.BanijahRightsProgrammeLayout.SubQCNum';
            var myModel = $('#form_jobdetails').serializeObject();

            console.log(myModel)

              $.post('/BanijayRights/SaveTapeLayout', { model: myModel }).done(function (data) {

                if (data.success == true) {
                    Msg.success(data.msg, 2 * 1000);
                    LoadTapeLayouts(qcno, revno);
                }
                else {
                    Msg.error(data.msg, 5 * 1000);
                }
            })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {

            });
          });

            rowOnClick();


            $('#deletePromptModal').on('shown.bs.modal', function () {

                var type = $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Type)').val();
                var modal = $(this);
                 modal.find('.modal-body').text('Are you sure you want to delete tape layout "' + type + '"?');

            });

              $('#btnDeletePrompt').on("click", function () {

             if ( $('#@Html.IdFor(m => m.BanijahRightsProgrammeLayout)').val() == '0')
            {
                return;
            }

            $('#deletePromptModal').modal('show');

        });

           $('#btnDelete').on("click", function () {

                $('#deletePromptModal').modal('hide');
                $('table tr').removeClass("selectedRow");
                var id = $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Id)').val()
                var qcno = '@Model.BanijahRightsProgrammeLayout.QCNum';
                var revno = '@Model.BanijahRightsProgrammeLayout.SubQCNum';

               $.post('/BanijayRights/DeleteTapeLayout', { id: id }).done(function (data) {

                if (data.success == true) {
                    Msg.success(data.msg, 2 * 1000);
                    LoadTapeLayouts(qcno, revno);

                }
                else {
                    Msg.error(data.msg, 5 * 1000);
                }
            })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {

                $('#deletePromptModal').modal('hide');
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();

            });
        });


        });

    });

    function rowOnClick() {

        $('.clickable-row').on('click', function () {

            $('table tr').removeClass("selectedRow");
            $(this).addClass("selectedRow");
            var id = $(this).data('id');
            $('#btnDeletePrompt').prop('disabled', false);
            $('#btnSave').text('Update');
            PopulateTapeLayout(id);

        });
    }

    function saveProgramme() {


         //Validate
        if ($('#@Html.IdFor(m => m.BanijahRightsProgrammeLayout.ProgrammeIn)').val() == '_:_:_'
             && $('#@Html.IdFor(m => m.BanijahRightsProgrammeLayout.ProgrammeIn)').val() == '') {
                  Msg.success("Please add a programme in timecode in and continue... ", 2 * 1000);
                  return;
              }

        if ($('#@Html.IdFor(m => m.BanijahRightsProgrammeLayout.ProgrammeOut)').val() == '_:_:_'
             && $('#@Html.IdFor(m => m.BanijahRightsProgrammeLayout.ProgrammeOut)').val() == '') {
                  Msg.success("Please add a programme out timecode in and continue... ", 2 * 1000);
                  return;
              }


        var myModel = $('#form_jobdetails').serializeObject();

        $.post('/BanijayRights/SaveProgrammeLayout', { model: myModel}).done(function (data) {

            if (data.success == true) {

                // Msg.success(data.msg, 2 * 1000);
            }
            else {
                Msg.error(data.msg, 5 * 1000);
            }
        })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {


            });
    }





    function LoadTapeLayouts(qcNumber, revNumber) {

        var scrollPosition = $('#divscroll').scrollTop();

        $.post('/BanijayRights/LoadTapeLayouts', { qcnum: qcNumber, revnum: revNumber }).done(function (data) {
            $("#divTapeLayoutGrid").html(data);
            Reset();
            rowOnClick();
        })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {
                $('#divscroll').scrollTop(scrollPosition);
            });
    }

    function PopulateTapeLayout(id) {

        var scrollPosition = $('#divscroll').scrollTop();

        $.post('/BanijayRights/PopulateTapeLayout', { id: id }).done(function (data) {

            console.log(data)

            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Id)').val(data.Id)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.ItemNum)').val(data.ItemNun)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Type)').val(data.Type)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeIn)').val(data.TimecodeIn)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeOut)').val(data.TimecodeOut)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.PartDurationExcludingHolds)').val(data.PartDurationExcludingHolds)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.CountAsShow)').val(data.CountAsShow)


        })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {
                $('#divscroll').scrollTop(scrollPosition);

            });
    }

     function Reset() {

         $('table tr').removeClass("selectedRow");

         $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Id)').val('0')
           $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.ItemNum)').val(@nextItemNo)
        $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Type)').val('')
        $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeIn)').val('')
        $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeOut)').val('')
        $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.PartDurationExcludingHolds)').val('')
        $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.CountAsShow)').val('')
        $('#btnDeletePrompt').prop('disabled', true);
        $('#btnSave').text('Save');
    }



</script>

