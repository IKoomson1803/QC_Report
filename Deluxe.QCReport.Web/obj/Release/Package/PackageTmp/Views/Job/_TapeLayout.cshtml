@model Deluxe.QCReport.Web.Models.HomeVM


@{

    var nextItemNo = 1;
    var lastItem = Model.TapeLayout_VM.Timecodes.OrderByDescending(m => m.ItemNum).FirstOrDefault();
    if (lastItem != null) { nextItemNo = lastItem.ItemNum + 1; }
    var itemNo = 0;
    var itemCount = Model.TapeLayout_VM.Timecodes.Count;
}

<div class="bs-callout bs-callout-warning" id="layout">
    <div class="row">
        <div class="col-xs-4">
            <b style="font-size:14px;">@string.Format("{0} - {1}: Layout", Model.TapeLayout_VM.Qcnum, Model.TapeLayout_VM.subQcnum)</b>
        </div>


        @if (Model.SecurityLevel >= 1)
        {

            <div class="col-xs-4">
                <div>
                    <button type="button" class="btn btn-xs btn-primary CRUDButton" id="btnSave">Save</button>
                    <button type="button" class="btn btn-xs btn-danger CRUDButton" id="btnReset" onclick="Reset()">Reset</button>
                    <button type="button" class="btn btn-xs btn-warning CRUDButton" id="btnDeletePrompt" disabled>Delete</button>
                </div>
            </div>

        }




    </div>

    @using (Html.BeginForm("SaveTapeLayoutDetails", "Job", FormMethod.Post, new { @class = "form-horizontal", @id = "form_jobdetails", @autocomplete = "on" }))
    {
        @Html.HiddenFor(m => m.TapeLayout_VM.Qcnum)
        @Html.HiddenFor(m => m.TapeLayout_VM.subQcnum)

        if (Model.TapeLayout_VM.CurrentTimecodes != null)
        {
            @Html.HiddenFor(m => m.TapeLayout_VM.CurrentTimecodes.TapeFormatId)
        }


        if (Model.SecurityLevel >= 1)

        {
            <div class="row">

                <div class="col-xs-1 form-group" style="margin-left:5px;">

                    <label class="control-label">Item:</label>
                    @Html.TextBoxFor(m => m.TapeLayout_VM.CurrentTimecodes.ItemNum, new { @class = "form-control", @type = "number", @width = "40px" })
                </div>

                <div class="col-xs-9 form-group" style="margin-left:5px;">

                    <label class="control-label">Description:</label>
                    @Html.TextBoxFor(m => m.TapeLayout_VM.CurrentTimecodes.Description, new { @class = "form-control", maxlength = "255", @autocomplete = "on" })
                    @*@Html.TextAreaFor(m => m.TapeLayout_VM.CurrentTimecodes.Description, 3, 3, new { @class = "form-control", maxlength = "255", @autocomplete = "on" })*@
                </div>

                <div class="col-xs-1 form-group floa-left" style="margin-left:5px;">

                    <label class="control-label">Duration:</label>
                    @Html.TextBoxFor(m => m.TapeLayout_VM.CurrentTimecodes.Length, new { @class = "form-control", maxlength = "16", @style = "width:70px" })
                </div>
                <div class="col-xs-1 form-group text-left" style="margin-left:5px;">

                    <label class="control-label">T.C.</label>
                    @Html.TextBoxFor(m => m.TapeLayout_VM.CurrentTimecodes.Time_Code, new { @class = "form-control timecode", placeholder = "hh:mm:ss:ff", maxlength = "11", @style = "width:90px" })
                </div>
            </div>


        }

    }


    @if (Model.TapeLayout_VM != null && Model.TapeLayout_VM.Timecodes != null && Model.TapeLayout_VM.Timecodes.Any())
    {
        <div class="row">
            <div class="col-xs-4 float-left">

                <div class="btn btn-xs btn-primary">
                    Total Items
                    <span class="badge"> @itemCount</span>
                </div>
            </div>
        </div>
        <br />

        <div id="divscroll" style="margin: 1px 0; height: 700px; overflow-y: auto; ">

            <table class="table table-striped table-condensed" style="margin-top:-5px;">
                <thead>
                    <tr>
                        <td>Item No.</td>
                        <td>Description</td>
                        <td>Duration</td>
                        <td>Time Code</td>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.TapeLayout_VM.Timecodes)
                    {
                        itemNo++;

                        <tr class='clickable-row' style="cursor:pointer;" data-tfid="@item.TapeFormatId">
                            <td class="col-xs-1">@item.ItemNum</td>
                            <td class="col-xs-7">@item.Description</td>
                            <td class="col-xs-1">@item.Length</td>
                            <td class="col-xs-3">@item.Time_Code</td>
                        </tr>

                    }
                </tbody>
            </table>

        </div>




    }


    <div class="row" style="margin-top:20px;">
        <div class="col-sm-4">


        </div>

    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="deletePromptModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-body" style="font-size:14px;font-weight:bold;">

            </div>
            <div class="modal-footer">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-sm btn-danger" id="btnDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    function setActiveButton() {
        $(".subMenuOnClick").removeClass("subMenuOnClick")
        $('#lnkQcTapeLayout').addClass("subMenuOnClick");
    }

  $(function () {

    $(function () {

        setActiveButton();

        $(".timecode").mask("99:99:99:99");

         $('#@Html.IdFor(m => m.TapeLayout_VM.CurrentTimecodes.ItemNum)').val(@nextItemNo);

        $('#btnSave').on("click", function () {

            if ($('#TapeLayout_VM_CurrentTimecodes_ItemNum').val() == '') {
                alert("Please add an item number and continue... ")
                return;
            }

            //var itemNumber = parseInt($('#TapeLayout_VM_CurrentTimecodes_ItemNum').val(), 10);

            //if (isNaN(itemNumber)) {
            //    itemNumber = 0;
            //}

            //if (itemNumber <= 0) {
            //    alert("Please add an item number and continue... ")
            //    return;
            //}


            //if ($('#TapeLayout_VM_CurrentTimecodes_Description').val() == '') {
            //    alert("Please add a description and continue... ")
            //    return;
            //}

            //if ($('#TapeLayout_VM_CurrentTimecodes_Time_Code').val() == '') {
            //    alert("Please add a timecode and continue... ")
            //    return;
            //}

            //$('.cssload-preloader').fadeIn();
            var qcno = '@Model.TapeLayout_VM.Qcnum';
            var revno = '@Model.TapeLayout_VM.subQcnum';
            var myModel = $('#form_jobdetails').serializeObject();

            $.post('/Job/SaveTapeLayoutDetails', { model: myModel }).done(function (data) {

                if (data.success == true) {
                    Msg.success(data.msg, 2 * 1000);
                    LoadTapeLayoutDetails(qcno, revno, null);
                }
                else {
                    Msg.error(data.msg, 5 * 1000);
                }
            })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {

                $('.cssload-preloader').hide();
            });
        });

        $('#deletePromptModal').on('shown.bs.modal', function () {

            var itemNo = $('#@Html.IdFor(m => m.TapeLayout_VM.CurrentTimecodes.ItemNum)').val();
            var modal = $(this);
            modal.find('.modal-body').text('Are you sure you want to delete record ' + itemNo + '?');

        });

        $('#btnDeletePrompt').on("click", function () {


            if ( $('#@Html.IdFor(m => m.TapeLayout_VM.CurrentTimecodes.TapeFormatId)').val() == '')
            {
                return;
            }

            $('#deletePromptModal').modal('show');

        });

        $('#btnDelete').on("click", function () {

            $('#deletePromptModal').modal('hide');

            var qcno = '@Model.TapeLayout_VM.Qcnum';
            var revno = '@Model.TapeLayout_VM.subQcnum';
            var myModel = $('#form_jobdetails').serializeObject();

            $.post('/Job/DeleteTapeLayoutDetails', { model: myModel }).done(function (data) {

                if (data.success == true) {
                    Msg.success(data.msg, 2 * 1000);
                    LoadTapeLayoutDetails(qcno, revno, null);
                }
                else {
                    Msg.error(data.msg, 5 * 1000);
                }
            })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {

                $('#deletePromptModal').modal('hide');
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();
            });
        });



        @*$('#btnLoadTC').on("click", function () {

            var tc = TimeCodeControl1.TimeCode;

            if (tc != null) {

                $('#@Html.IdFor(m => m.TapeLayout_VM.CurrentTimecodes.Time_Code)').val(tc);
            }
        });*@


        // add ':' in timecode textbox
        @*$('#@Html.IdFor(m => m.TapeLayout_VM.CurrentTimecodes.Time_Code)').on('keyup', function () {

            var currentValue = $(this).val();

            if (currentValue.length == 2 ||
                currentValue.length == 5 ||
                currentValue.length == 8) {

                $(this).val(currentValue + ':');
            }

        });*@

        $('.clickable-row').on('click', function () {

            $('table tr').removeClass("selectedRow");
            $(this).addClass("selectedRow");

            //$('.cssload-preloader').fadeIn();
            var qcno = '@Model.TapeLayout_VM.Qcnum';
            var revno = '@Model.TapeLayout_VM.subQcnum';
            var tfno = $(this).data('tfid');
            $('#btnDeletePrompt').prop('disabled', false);
            $('#btnSave').text('Update');
            PopulateLayoutItemDetails(qcno, revno, tfno);

        });

        if ('@Model.TapeLayout_VM.CurrentTimecodes' != '') {

            //$('#btnDeletePrompt').prop('disabled', false);
            //$('#btnSave').text('Update');
        }
        else {
            $('#@Html.IdFor(m => m.TapeLayout_VM.CurrentTimecodes.ItemNum)').val(@nextItemNo);
        }

        //**************Save Layout Item on enter **********************************************

        $('#TapeLayout_VM_CurrentTimecodes_Description').keyup(function (event) {
            if (event.key == 'Enter') {
                SaveLayoutEnterClick();
            }
        });

        $('#TapeLayout_VM_CurrentTimecodes_Length').keyup(function (event) {
            if (event.key == 'Enter') {
                SaveLayoutEnterClick();
            }
        });

        $('#TapeLayout_VM_CurrentTimecodes_Time_Code').keyup(function (event) {
            if (event.key == 'Enter') {
                SaveLayoutEnterClick();
            }
        });


    });

  });

    function SaveLayoutEnterClick() {

        $('#btnSave').click();

    }

    function LoadTapeLayoutDetails(qcno, revno, tfno) {

        var scrollPosition = $('#divscroll').scrollTop();

        $.post('/Job/TapeLayoutDetails', { qcnum: qcno, revnum: revno, tfid: tfno }).done(function (data) {
            $("#divContent").html(data);
            Reset();
        })
        .fail(function (xdata) {

            Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
        })
        .always(function () {
            $('#divscroll').scrollTop(scrollPosition);
        });
    }

    function PopulateLayoutItemDetails(qcno, revno, tfno) {

        var scrollPosition = $('#divscroll').scrollTop();


        $.post('/Job/PopulateLayoutItemDetails', { qcnum: qcno, revnum: revno, tfid: tfno }).done(function (data) {

            console.log(data)

            $('#TapeLayout_VM_CurrentTimecodes_TapeFormatId').val(tfno);
            $('#TapeLayout_VM_CurrentTimecodes_ItemNum').val(data.ItemNum);
            $('#TapeLayout_VM_CurrentTimecodes_Description').val(data.Description);
            $('#TapeLayout_VM_CurrentTimecodes_Time_Code').val(data.Time_Code);
            $('#TapeLayout_VM_CurrentTimecodes_Length').val(data.Length);
        })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {
                $('#divscroll').scrollTop(scrollPosition);
            });
    }

    function Reset() {
     
            $('table tr').removeClass("selectedRow");
            $('#@Html.IdFor(m => m.TapeLayout_VM.CurrentTimecodes.TapeFormatId)').val('0');
            $('#@Html.IdFor(m => m.TapeLayout_VM.CurrentTimecodes.ItemNum)').val(@nextItemNo);
            $('#@Html.IdFor(m => m.TapeLayout_VM.CurrentTimecodes.Description)').val('');
            $('#@Html.IdFor(m => m.TapeLayout_VM.CurrentTimecodes.Length)').val('');
            $('#@Html.IdFor(m => m.TapeLayout_VM.CurrentTimecodes.Time_Code)').val('');
            $('#btnDeletePrompt').prop('disabled', true);
            $('#btnSave').text('Save');

    }
</script>
