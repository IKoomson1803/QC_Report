@model Deluxe.QCReport.Web.Models.HomeVM

@{
    var tapeLayouts = Model.BanijahRightsTapeLayouts;
    var itemCount = tapeLayouts.Count;
    var itemNo = 0;

    var nextItemNo = 1;
    var lastItem = Model.BanijahRightsProgrammeLayout.TapeLayouts.OrderByDescending(m => m.ItemNum).FirstOrDefault();
    if (lastItem != null) { nextItemNo = lastItem.ItemNum + 1; }
}

@if (tapeLayouts != null && tapeLayouts.Any())
{
    <div class="col-xs-10">


        <div class="row">
            <div class="col-xs-4 float-left">
                <div class="btn btn-xs btn-primary">
                    Layout Items
                    <span class="badge"> @itemCount</span>
                </div>
            </div>
        </div>

        <div id="divscroll" style="height:700px; overflow-y:auto;">

            <table id="tblTimecodes" cellspacing="0" class="table table-striped table-condensed">
                <thead>
                    <tr>
                        <td> Item No.</td>
                        <td>Layout</td>
                        <td>Timecode In</td>
                        <td>Timecode Out</td>
                        <td> Part Duration ex holds</td>
                        <td> Count As Show</td>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tapeLayout in tapeLayouts)
                    {
                        itemNo++;

                        <tr class='clickable-row' style="cursor:pointer;" data-id="@tapeLayout.Id" title="Click the row to update the tape layout">
                            <td>@tapeLayout.ItemNum</td>

                            <td class="col-xs-2">
                                @tapeLayout.Type
                            </td>
                            <td class="col-xs-2">
                                @tapeLayout.TimecodeIn
                            </td>
                            <td class="col-xs-2">
                                @tapeLayout.TimecodeOut
                            </td>
                            <td class="col-xs-2">
                                @tapeLayout.PartDurationExcludingHolds
                            </td>
                            <td class="col-xs-2">
                                @tapeLayout.CountAsShow
                            </td>
                        </tr>
                    }

                </tbody>
            </table>

        </div>


    </div>


}


<script>


    $(function () {
        $(function () {


                $(".timecode").mask("99:99:99:99");

                 $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.ItemNum)').val(@nextItemNo)


            $('#btnSave').on("click", function () {

                if ($('#@Html.IdFor(m => m.BanijahRightsTapeLayout.ItemNum)').val() == '') {
                    alert("Please add an item number and continue... ")
                    return;
                }

              if ($('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Type)').val() == '') {
                  Msg.success("Please add a tape layout type and continue... ", 2 * 1000);
                  return;
              }

              if ($('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeIn)').val() == '_:_:_'
               && $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeIn)').val() == '') {
                  Msg.success("Please add a tape layout timecode in and continue... ", 2 * 1000);
                  return;
              }

              if ($('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeOut)').val() == '_:_:_'
              && $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeOut)').val() == '') {
                  Msg.success("Please add a tape layout timecode out and continue... ", 2 * 1000);
                  return;
              }

            var qcno = '@Model.BanijahRightsProgrammeLayout.QCNum';
            var revno = '@Model.BanijahRightsProgrammeLayout.SubQCNum';
            var myModel = $('#form_jobdetails').serializeObject();

            console.log(myModel)

              $.post('/BanijayRights/SaveTapeLayout', { model: myModel }).done(function (data) {

                if (data.success == true) {
                    Msg.success(data.msg, 2 * 1000);
                    LoadTapeLayouts(qcno, revno);

                }
                else {
                    Msg.error(data.msg, 5 * 1000);
                }
            })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {

            });
          });

            rowOnClick();


            $('#deletePromptModal').on('shown.bs.modal', function () {

                var type = $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Type)').val();
                var modal = $(this);
                 modal.find('.modal-body').text('Are you sure you want to delete tape layout "' + type + '"?');

            });

              $('#btnDeletePrompt').on("click", function () {

             if ( $('#@Html.IdFor(m => m.BanijahRightsProgrammeLayout)').val() == '0')
            {
                return;
            }

            $('#deletePromptModal').modal('show');

        });

           $('#btnDelete').on("click", function () {

                $('#deletePromptModal').modal('hide');
                $('table tr').removeClass("selectedRow");
                var id = $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Id)').val()
                var qcno = '@Model.BanijahRightsProgrammeLayout.QCNum';
                var revno = '@Model.BanijahRightsProgrammeLayout.SubQCNum';

               $.post('/BanijayRights/DeleteTapeLayout', { id: id }).done(function (data) {

                if (data.success == true) {
                    Msg.success(data.msg, 2 * 1000);
                    LoadTapeLayouts(qcno, revno);

                }
                else {
                    Msg.error(data.msg, 5 * 1000);
                }
            })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {

                $('#deletePromptModal').modal('hide');
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();

            });
           });

            //**************Save Layout Item on enter ********************************************


             $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.ItemNum)').keyup(function (event) {
                if (event.key == 'Enter') {
                    SaveLayoutEnterClick();
                }
            });

             $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeIn)').keyup(function (event) {
                if (event.key == 'Enter') {
                    SaveLayoutEnterClick();
                }
            });

             $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeOut)').keyup(function (event) {
                if (event.key == 'Enter') {
                    SaveLayoutEnterClick();
                }
            });

             $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.PartDurationExcludingHolds)').keyup(function (event) {
                if (event.key == 'Enter') {
                    SaveLayoutEnterClick();
                }
            });

             $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.CountAsShow)').keyup(function (event) {
                if (event.key == 'Enter') {
                    SaveLayoutEnterClick();
                }
            });


        });

    });

    function SaveLayoutEnterClick() {

        $('#btnSave').click();

    }

    function rowOnClick() {

        $('.clickable-row').on('click', function () {

            $('table tr').removeClass("selectedRow");
            $(this).addClass("selectedRow");
            var id = $(this).data('id');
            $('#btnDeletePrompt').prop('disabled', false);
            $('#btnSave').text('Update');
            PopulateTapeLayout(id);

        });
    }


    function LoadTapeLayouts(qcNumber, revNumber) {

        var scrollPosition = $('#divscroll').scrollTop();
        ''
        $.post('/BanijayRights/LoadTapeLayouts', { qcnum: qcNumber, revnum: revNumber }).done(function (data) {
            $("#divTapeLayoutGrid").html(data);
             Reset();
           // rowOnClick();
        })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {
                $('#divscroll').scrollTop(scrollPosition);
            });
    }

    function PopulateTapeLayout(id) {

        var scrollPosition = $('#divscroll').scrollTop();

        $.post('/BanijayRights/PopulateTapeLayout', { id: id }).done(function (data) {

            console.log(data)

            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Id)').val(data.Id)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.ItemNum)').val(data.ItemNum)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Type)').val(data.Type)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeIn)').val(data.TimecodeIn)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeOut)').val(data.TimecodeOut)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.PartDurationExcludingHolds)').val(data.PartDurationExcludingHolds)
            $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.CountAsShow)').val(data.CountAsShow)


        })
            .fail(function (xdata) {

                Msg.error('Error occured! <b>Status:</b> ' + xdata.status + ' <b>Error Message:</b> ' + xdata.statusText, 5 * 1000);
            })
            .always(function () {
                $('#divscroll').scrollTop(scrollPosition);

            });
    }

     function Reset() {

         $('table tr').removeClass("selectedRow");

         $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Id)').val('0')
         $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.ItemNum)').val(@nextItemNo)
        $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.Type)').val('')
        $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeIn)').val('')
        $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.TimecodeOut)').val('')
        $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.PartDurationExcludingHolds)').val('')
        $('#@Html.IdFor(m => m.BanijahRightsTapeLayout.CountAsShow)').val('')
        $('#btnDeletePrompt').prop('disabled', true);
        $('#btnSave').text('Save');
    }



</script>


